name: release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.[0-9]+.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 2.0.0, 2.0.0-alpha.01, 2.0.0-beta.01, 2.0.0-rc.01)'
        required: true

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine version & tag
        shell: powershell
        run: |
          # use dispatched input, env var, or secret
          $V = '${{ github.event.inputs.version }}'
          if ([string]::IsNullOrEmpty($V)) { $V = $env:VERSION }
          if ([string]::IsNullOrEmpty($V)) { $V = '${{ secrets.VERSION }}' }
          "VERSION=$V" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "APP_VERSION=$V" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "TAG=v$V" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          # Note: GraalVM locks files
          distribution: jetbrains
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4.4.3
        with:
          gradle-version: wrapper
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          cache-read-only: false

      - name: Generate ktlint baseline
        if: env.ACT != 'true'
        shell: powershell
        run: .\gradlew.bat ktlintGenerateBaseline

      - name: Prepare artifact staging directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path app/out | Out-Null

      - name: Build JAR distribution
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'JAR'
          .\gradlew.bat app:buildWithProjectModules
          Copy-Item app/build/libs/ServerListExplorer.jar app/out/ServerListExplorer.jar -Force

      - name: Build Fat JAR distribution
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'Fat JAR'
          .\gradlew.bat app:shadowJar
          Copy-Item app/build/libs/ServerListExplorer-all.jar app/out/ServerListExplorer-all.jar -Force

      - name: Build MSI installer (Fat JAR)
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'MSI Installer (Fat JAR)'
          .\gradlew.bat app:packageMsi
          $msi = Get-ChildItem app/build/compose/binaries/main/msi/ServerListExplorer-*.msi | Select-Object -First 1
          Copy-Item $msi.FullName ("app/out/ServerListExplorer_installer-$($env:VERSION).msi") -Force

      - name: Build EXE installer (Fat JAR)
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'EXE Installer (Fat JAR)'
          .\gradlew.bat app:packageExe
          $exe = Get-ChildItem app/build/compose/binaries/main/exe/ServerListExplorer-*.exe | Select-Object -First 1
          Copy-Item $exe.FullName ("app/out/ServerListExplorer_installer-$($env:VERSION).exe") -Force

      - name: Build Portable (Fat JAR)
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'Portable (Fat JAR)'
          .\gradlew.bat app:createDistributable
          $portableDir = "app/build/compose/binaries/main/app/ServerListExplorer"
          $portableZip = "app/out/ServerListExplorer_portable-$($env:VERSION).zip"
          if (Test-Path $portableZip) { Remove-Item $portableZip -Force }
          Compress-Archive -Path $portableDir -DestinationPath $portableZip -Force

      - name: Build Minified Fat JAR distribution
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'Minified Fat JAR'
          .\gradlew.bat app:packageReleaseUberJarForCurrentOS
          $releaseJar = Get-ChildItem app/build/compose/jars/ServerListExplorer-windows-x64-*-release.jar | Select-Object -First 1
          Copy-Item $releaseJar.FullName app/out/ServerListExplorer-all-minified.jar -Force

      - name: Build MSI installer (Minified Fat JAR)
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'MSI Installer (Minified Fat JAR)'
          .\gradlew.bat app:packageReleaseMsi
          $msi = Get-ChildItem app/build/compose/binaries/main-release/msi/ServerListExplorer-*.msi | Select-Object -First 1
          Copy-Item $msi.FullName ("app/out/ServerListExplorer-minified_installer-$($env:VERSION).msi") -Force

      - name: Build EXE installer (Minified Fat JAR)
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'EXE Installer (Minified Fat JAR)'
          .\gradlew.bat app:packageReleaseExe
          $exe = Get-ChildItem app/build/compose/binaries/main-release/exe/ServerListExplorer-*.exe | Select-Object -First 1
          Copy-Item $exe.FullName ("app/out/ServerListExplorer-minified_installer-$($env:VERSION).exe") -Force

      - name: Build Portable (Minified Fat JAR)
        shell: powershell
        run: |
          $env:APP_DISTRIBUTION = 'Portable (Minified Fat JAR)'
          .\gradlew.bat app:createReleaseDistributable
          $portableDir = "app/build/compose/binaries/main-release/app/ServerListExplorer"
          $portableZip = "app/out/ServerListExplorer-minified_portable-$($env:VERSION).zip"
          if (Test-Path $portableZip) { Remove-Item $portableZip -Force }
          Compress-Archive -Path $portableDir -DestinationPath $portableZip -Force

      - name: List Compose JARs
        shell: powershell
        run: |
          Write-Host "=== app/build/compose/jars ==="
          Get-ChildItem app/build/compose/jars

      - name: Create GitHub Release
        if: env.ACT != 'true'
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: ${{ env.TAG }}
          name: "Server List Explorer ${{ env.TAG }}"
          body: ${{ steps.changelog.outputs.changelog }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(env.TAG, '-beta') || contains(env.TAG, '-rc') || contains(env.TAG, '-alpha') }}
          files: |
            app/out/ServerListExplorer.jar
            app/out/ServerListExplorer-all.jar
            app/out/ServerListExplorer-all-minified.jar
            app/out/ServerListExplorer-minified_installer-${{ env.VERSION }}.msi
            app/out/ServerListExplorer_installer-${{ env.VERSION }}.msi
            app/out/ServerListExplorer-minified_installer-${{ env.VERSION }}.exe
            app/out/ServerListExplorer_installer-${{ env.VERSION }}.exe
            app/out/ServerListExplorer-minified_portable-${{ env.VERSION }}.zip
            app/out/ServerListExplorer_portable-${{ env.VERSION }}.zip

      - name: Upload artifacts to workflow run
        if: env.ACT != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sle-${{ env.TAG }}
          path: |
            app/out/ServerListExplorer.jar
            app/out/ServerListExplorer-all.jar
            app/out/ServerListExplorer-all-minified.jar
            app/out/ServerListExplorer-minified_installer-${{ env.VERSION }}.msi
            app/out/ServerListExplorer_installer-${{ env.VERSION }}.msi
            app/out/ServerListExplorer-minified_installer-${{ env.VERSION }}.exe
            app/out/ServerListExplorer_installer-${{ env.VERSION }}.exe
            app/out/ServerListExplorer-minified_portable-${{ env.VERSION }}.zip
            app/out/ServerListExplorer_portable-${{ env.VERSION }}.zip
