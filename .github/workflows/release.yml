name: release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.[0-9]+.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 2.0.0, 2.0.0-alpha.01, 2.0.0-beta.01, 2.0.0-rc.01)'
        required: true

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine version & tag
        shell: powershell
        run: |
          # use dispatched input, env var, or secret
          $V = '${{ github.event.inputs.version }}'
          if ([string]::IsNullOrEmpty($V)) { $V = $env:VERSION }
          if ([string]::IsNullOrEmpty($V)) { $V = '${{ secrets.VERSION }}' }
          "VERSION=$V" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "APP_VERSION=$V" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "TAG=v$V" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          # Note: GraalVM locks files
          distribution: jetbrains
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          cache-read-only: false

      - name: Generate ktlint baseline
        if: env.ACT != 'true'
        shell: powershell
        run: .\gradlew.bat ktlintGenerateBaseline

      - name: Prepare artifact staging directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path app/out | Out-Null

      - name: Build all distributions
        shell: powershell
        run: |
          .\gradlew.bat app:buildWithProjectModules
          .\gradlew.bat app:shadowJar
          .\gradlew.bat app:createDistributable
          .\gradlew.bat app:packageMsi
          .\gradlew.bat app:packageExe
          .\gradlew.bat app:packageReleaseUberJarForCurrentOS
          .\gradlew.bat app:createReleaseDistributable
          .\gradlew.bat app:packageReleaseMsi
          .\gradlew.bat app:packageReleaseExe

      - name: Copy artifacts to staging directory
        shell: powershell
        run: |
          # Copy JAR distributions
          Copy-Item app/build/libs/ServerListExplorer.jar app/out/ServerListExplorer.jar -Force
          Copy-Item app/build/libs/ServerListExplorer-all.jar app/out/ServerListExplorer-all.jar -Force

          # Copy minified JAR
          $releaseJar = Get-ChildItem app/build/compose/jars/ServerListExplorer-windows-x64-*-release.jar | Select-Object -First 1
          Copy-Item $releaseJar.FullName app/out/ServerListExplorer-all-minified.jar -Force

          # Copy MSI installers
          $msi = Get-ChildItem app/build/compose/binaries/main/msi/ServerListExplorer-*.msi | Select-Object -First 1
          Copy-Item $msi.FullName ("app/out/ServerListExplorer_$($env:VERSION)_x64.msi") -Force

          $msiMinified = Get-ChildItem app/build/compose/binaries/main-release/msi/ServerListExplorer-*.msi | Select-Object -First 1
          Copy-Item $msiMinified.FullName ("app/out/ServerListExplorer_$($env:VERSION)-minified_x64.msi") -Force

          # Copy EXE installers
          $exe = Get-ChildItem app/build/compose/binaries/main/exe/ServerListExplorer-*.exe | Select-Object -First 1
          Copy-Item $exe.FullName ("app/out/ServerListExplorer_$($env:VERSION)_x64-setup.exe") -Force

          $exeMinified = Get-ChildItem app/build/compose/binaries/main-release/exe/ServerListExplorer-*.exe | Select-Object -First 1
          Copy-Item $exeMinified.FullName ("app/out/ServerListExplorer_$($env:VERSION)-minified_x64-setup.exe") -Force

          # Create portable ZIP archives
          $portableDir = "app/build/compose/binaries/main/app/ServerListExplorer"
          $portableZip = "app/out/ServerListExplorer_$($env:VERSION)_windows-x64-portable.zip"
          if (Test-Path $portableZip) { Remove-Item $portableZip -Force }
          Compress-Archive -Path $portableDir -DestinationPath $portableZip -Force

          $portableDirMinified = "app/build/compose/binaries/main-release/app/ServerListExplorer"
          $portableZipMinified = "app/out/ServerListExplorer_$($env:VERSION)-minified_windows-x64-portable.zip"
          if (Test-Path $portableZipMinified) { Remove-Item $portableZipMinified -Force }
          Compress-Archive -Path $portableDirMinified -DestinationPath $portableZipMinified -Force

      - name: List Compose JARs
        shell: powershell
        run: |
          Write-Host "=== app/build/compose/jars ==="
          Get-ChildItem app/build/compose/jars

      - name: Create GitHub Release
        if: env.ACT != 'true'
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ env.TAG }}
          name: "Server List Explorer ${{ env.TAG }}"
          body: ${{ steps.changelog.outputs.changelog }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(env.TAG, '-beta') || contains(env.TAG, '-rc') || contains(env.TAG, '-alpha') }}
          files: |
            app/out/ServerListExplorer.jar
            app/out/ServerListExplorer-all.jar
            app/out/ServerListExplorer-all-minified.jar
            app/out/ServerListExplorer_${{ env.VERSION }}-minified_x64.msi
            app/out/ServerListExplorer_${{ env.VERSION }}_x64.msi
            app/out/ServerListExplorer_${{ env.VERSION }}-minified_x64-setup.exe
            app/out/ServerListExplorer_${{ env.VERSION }}_x64-setup.exe
            app/out/ServerListExplorer_${{ env.VERSION }}-minified_windows-x64-portable.zip
            app/out/ServerListExplorer_${{ env.VERSION }}_windows-x64-portable.zip

      - name: Upload artifacts to workflow run
        if: env.ACT != 'true'
        uses: actions/upload-artifact@v5
        with:
          name: sle-${{ env.TAG }}
          path: |
            app/out/ServerListExplorer.jar
            app/out/ServerListExplorer-all.jar
            app/out/ServerListExplorer-all-minified.jar
            app/out/ServerListExplorer_${{ env.VERSION }}-minified_x64.msi
            app/out/ServerListExplorer_${{ env.VERSION }}_x64.msi
            app/out/ServerListExplorer_${{ env.VERSION }}-minified_x64-setup.exe
            app/out/ServerListExplorer_${{ env.VERSION }}_x64-setup.exe
            app/out/ServerListExplorer_${{ env.VERSION }}-minified_windows-x64-portable.zip
            app/out/ServerListExplorer_${{ env.VERSION }}_windows-x64-portable.zip
