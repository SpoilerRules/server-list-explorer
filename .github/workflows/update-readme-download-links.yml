name: update-readme-download-links

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      tag:
        required: true
        type: string
      asset_version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-readme:
    name: Update README Download Links
    runs-on: ubuntu-latest

    steps:
      - name: Check out default branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Rewrite README Available Downloads links
        shell: bash
        env:
          TAG: ${{ inputs.tag }}
          ASSET_VERSION: ${{ inputs.asset_version }}
          REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          BASE_URL="https://github.com/$REPOSITORY/releases/download/$TAG"

          export ASSET_VERSION
          export BASE_URL

          node <<'NODE'
          const fs = require("node:fs");

          const readmePath = "README.md";
          const assetVersion = process.env.ASSET_VERSION;
          const baseUrl = process.env.BASE_URL;

          const content = fs.readFileSync(readmePath, "utf8");

          const sectionHeaderRegex = /^#{2,3}\s+Available Downloads\s*$/m;
          const nextHeader = "\n## System Requirements";
          const sectionHeaderMatch = content.match(sectionHeaderRegex);
          if (!sectionHeaderMatch || sectionHeaderMatch.index === undefined) {
            throw new Error('Could not find "## Available Downloads" or "### Available Downloads" in README.md');
          }
          const sectionHeaderIndex = sectionHeaderMatch.index;

          const sectionStartIndex = content.indexOf("\n", sectionHeaderIndex) + 1;
          const sectionEndIndex = content.indexOf(nextHeader, sectionStartIndex);
          if (sectionEndIndex === -1) {
            throw new Error('Could not find "## System Requirements" after "Available Downloads" in README.md');
          }

          let section = content.slice(sectionStartIndex, sectionEndIndex);

          const releaseAssetLinkRegex =
            /\[([^\]]+)\]\((https:\/\/github\.com\/[^\/]+\/[^\/]+\/releases\/(?:latest\/download|download\/[^\/)]+)\/([^\/)\s]+))\)/g;

          const detectWindowsArch = (filename) => {
            if (/(arm64|aarch64)/i.test(filename)) {
              return "arm64";
            }
            return "x64";
          };

          const detectDebArch = (filename) => {
            if (/_(arm64|aarch64)\.deb$/i.test(filename)) {
              return "arm64";
            }
            return "amd64";
          };

          const mapAssetName = (filename) => {
            if (/\.msi$/i.test(filename)) {
              const minified = /minified/i.test(filename) ? "minified-" : "";
              const arch = detectWindowsArch(filename);
              return `ServerListExplorer-${minified}${assetVersion}-windows-${arch}.msi`;
            }

            if (/-setup\.exe$/i.test(filename)) {
              const minified = /minified/i.test(filename) ? "minified-" : "";
              const arch = detectWindowsArch(filename);
              return `ServerListExplorer-${minified}${assetVersion}-windows-${arch}-setup.exe`;
            }

            if (/portable\.zip$/i.test(filename)) {
              const minified = /minified/i.test(filename) ? "minified-" : "";
              const arch = detectWindowsArch(filename);
              return `ServerListExplorer-${minified}${assetVersion}-windows-${arch}-portable.zip`;
            }

            if (/\.tar\.gz$/i.test(filename)) {
              const minified = /minified/i.test(filename) ? "minified-" : "";
              const arch = /(arm64|aarch64)/i.test(filename) ? "arm64" : "x64";
              return `ServerListExplorer-${minified}${assetVersion}-linux-${arch}.tar.gz`;
            }

            if (/\.deb$/i.test(filename)) {
              const minified = /server-list-explorer-minified|minified|\+opt/i.test(filename);
              const debArch = detectDebArch(filename);
              const debVersion = minified ? `${assetVersion}+opt` : assetVersion;
              return `server-list-explorer_${debVersion}_${debArch}.deb`;
            }

            if (/\.jar$/i.test(filename)) {
              if (/minified-all\.jar$/i.test(filename) || /all-minified\.jar$/i.test(filename)) {
                return `ServerListExplorer-${assetVersion}-minified-all.jar`;
              }
              if (/all\.jar$/i.test(filename)) {
                return `ServerListExplorer-${assetVersion}-all.jar`;
              }
              return `ServerListExplorer-${assetVersion}.jar`;
            }

            return null;
          };

          let replacedLinks = 0;
          section = section.replace(releaseAssetLinkRegex, (_match, linkText, _url, filename) => {
            const newFilename = mapAssetName(filename);
            if (!newFilename) {
              return _match;
            }

            replacedLinks += 1;
            const keepExistingText = /\bDownload\b/i.test(linkText);
            const newText = keepExistingText ? linkText : newFilename;
            return `[${newText}](${baseUrl}/${newFilename})`;
          });

          if (replacedLinks === 0) {
            throw new Error("No release asset links were detected in README.md Available Downloads section");
          }

          const updated = content.slice(0, sectionStartIndex) + section + content.slice(sectionEndIndex);
          if (updated !== content) {
            fs.writeFileSync(readmePath, updated, "utf8");
          }
          NODE

      - name: Commit and push README updates
        shell: bash
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail

          if git diff --quiet -- README.md; then
            echo "README.md already up to date."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "docs: update README download links for $TAG"
          git push origin "HEAD:${{ github.event.repository.default_branch }}"
